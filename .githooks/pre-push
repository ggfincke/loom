#!/bin/sh
# .githooks/pre-push
# ensure CHANGELOG.md is updated when pushing to nightly branch

remote="$1"
url="$2"

# read stdin to get list of refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
    # * check if we're pushing to nightly branch
    if [ "$remote_ref" = "refs/heads/nightly" ]; then
        # check if we're in a rebase - allow push without strict validation
        if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ]; then
            echo "üì¶ rebase in progress - skipping strict nightly validation"
            continue
        fi
        
        echo "üîç checking nightly branch push requirements..."
        
        # verify that pyproject.toml & CHANGELOG.md versions are in sync
        pyproject_version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        changelog_version=$(head -n 20 CHANGELOG.md | grep -o '\[[^]]*\]' | head -n 1 | tr -d '[]')
        
        if [ "$pyproject_version" != "$changelog_version" ]; then
            echo ""
            echo "‚ùå version mismatch between pyproject.toml & CHANGELOG.md"
            echo "   pyproject.toml: $pyproject_version"
            echo "   CHANGELOG.md: $changelog_version"
            echo ""
            echo "please ensure both files have the same version before pushing to nightly."
            echo "run 'git commit --amend' to fix the version sync, then try pushing again."
            echo ""
            exit 1
        fi
        
        echo "‚úÖ pyproject.toml & CHANGELOG.md versions are in sync: $pyproject_version"
        
        # if this is not a deletion (local_sha is not all zeros)
        if [ "$local_sha" != "0000000000000000000000000000000000000000" ]; then
            # check if CHANGELOG.md was modified in any commits since last push
            if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
                # first push to this branch, check if CHANGELOG.md exists
                if [ -f "CHANGELOG.md" ]; then
                    echo "‚úÖ CHANGELOG.md exists for initial push"
                    continue
                else
                    echo "‚ùå CHANGELOG.md is required for nightly branch"
                    exit 1
                fi
            else
                # check if CHANGELOG.md was modified in the commit range
                if git diff --name-only "$remote_sha..$local_sha" | grep -q "CHANGELOG.md"; then
                    echo "‚úÖ CHANGELOG.md was updated in this push"
                else
                    echo ""
                    echo "‚ùå CHANGELOG.md must be updated when pushing to nightly branch"
                    echo ""
                    echo "please document your changes in CHANGELOG.md before pushing to nightly."
                    echo "add a new entry w/ your version & changes, then try pushing again."
                    echo ""
                    exit 1
                fi
            fi
        fi
    fi
done

echo "‚úÖ pre-push checks passed"
exit 0